// This is a manifest file that'll be compiled into including all the files listed below.
// Add new JavaScript/Coffee code in separate files in this directory and they'll automatically
// be included in the compiled file accessible from http://example.com/assets/application.js
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// the compiled file.
//
//= require namespace
//= require jquery-ui/dialog

(function () {
    namespace("soccer");
    soccer.tryouts = (function () {

        var _default_text = "<%= I18n.t('registration.tryouts.heading') %>";
        var _month_node;
        var _day_node;
        var _year_node;
        var _gender_name;

        var _birthdate_changed = function(e) {
            var month = _month_node.val();
            var day = _day_node.val();
            var year = _year_node.val();
            var gender = $('input[name="' + _gender_name + '"]:checked').val();

            if (month && day && year && gender) {
                $.get('<%= Rails.application.routes.url_helpers.tryouts_agelevel_path(:only_path => true) %>?month=' + month + '&year=' + year + '&gender=' + gender, function(tryout_info) {
                    _set_tryout_text(tryout_info);
                });
            } else {
                _set_tryout_text(_default_text);
            }
        };

        var _set_tryout_text = function(text) {
            var tryouts_date_and_time = $('#tryouts_date_and_times');
            tryouts_date_and_time.html(text);
        };

        var _get_current_year = function() {
            var date = new Date();
            var year = date.getFullYear();
            var month = date.getMonth();

            // Because this is tryouts, we need to move to the next playing year if we're in September or later
            // month is 0-11, so 7 is August
            if (month > 7) {
                year++;
            }

            return year;
        };

        return {
            init_registration: function(month, day, year, gender) {

                // Save off dom elements
                _month_node = $('#' + month);
                _day_node = $('#' + day);
                _year_node = $('#' + year);
                _gender_name = gender;

                // Register change handlers for birthdate
                _month_node.change(_birthdate_changed);
                _day_node.change(_birthdate_changed);
                _year_node.change(_birthdate_changed);
                $('input[name="' + _gender_name + '"]').change(_birthdate_changed);

                _set_tryout_text(_default_text);
            },

            show_age_group_chart: function(e) {
                $('#age_group_chart').click(function() {

                    $.get('<%= Rails.application.routes.url_helpers.tryouts_agegroupchart_path(:only_path => true) %>?season=' + _get_current_year(), function(data) {

                        e.html(data);
                        e.dialog({
                            draggable: false,
                            width: 960,
                            height: 'auto',
                            position: 'center',
                            modal: true,
                            zIndex: 4,
                            show: { effect: 'fade'},
                            hide: { effect: 'fade'}
                        });
                    });

                    return false;
                });
            }
        };
    }());
}());
